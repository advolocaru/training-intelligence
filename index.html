<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Training Intelligence - Your personal running dashboard with Strava integration">
    <meta name="theme-color" content="#8b5cf6">
    <title>Training Intelligence - Athlete Performance Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" defer></script>
    <style>
:root{--bg-primary:#0a0a0f;--bg-surface:#141420;--bg-surface-hover:#1a1a2e;--bg-elevated:#1e1e30;--border-color:#2a2a3e;--border-subtle:#1f1f2e;--text-primary:#f5f5f7;--text-secondary:#8888a0;--text-tertiary:#5a5a70;--accent:#8b5cf6;--accent-hover:#a78bfa;--accent-muted:rgba(139,92,246,0.15);--success:#22c55e;--success-muted:rgba(34,197,94,0.15);--warning:#eab308;--warning-muted:rgba(234,179,8,0.15);--error:#ef4444;--error-muted:rgba(239,68,68,0.15);--info:#3b82f6;--info-muted:rgba(59,130,246,0.15);--strava:#fc4c02;--strava-muted:rgba(252,76,2,0.15);--sidebar-width:240px;--sidebar-collapsed:72px;--topbar-height:64px;--card-padding:24px;--gap-lg:24px;--gap-md:16px;--gap-sm:8px;--gap-xs:4px;--radius-lg:16px;--radius-md:12px;--radius-sm:8px;--radius-xs:6px;--shadow-md:0 4px 12px rgba(0,0,0,0.4);--shadow-lg:0 8px 24px rgba(0,0,0,0.5);--transition-fast:150ms ease;--transition-base:200ms ease}
[data-theme="light"]{--bg-primary:#f5f5f7;--bg-surface:#ffffff;--bg-surface-hover:#f0f0f5;--bg-elevated:#ffffff;--border-color:#e5e5ea;--border-subtle:#ebebf0;--text-primary:#1a1a2e;--text-secondary:#6b6b80;--text-tertiary:#9898a8;--accent:#7c3aed;--accent-hover:#6d28d9;--accent-muted:rgba(124,58,237,0.1);--shadow-md:0 4px 12px rgba(0,0,0,0.08);--shadow-lg:0 8px 24px rgba(0,0,0,0.12)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);font-size:14px;line-height:1.5;overflow-x:hidden}
.app-container{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-width);height:100vh;position:fixed;left:0;top:0;background:var(--bg-surface);border-right:1px solid var(--border-color);display:flex;flex-direction:column;transition:width var(--transition-base);z-index:100}
.sidebar.collapsed{width:var(--sidebar-collapsed)}
.sidebar-header{height:var(--topbar-height);padding:0 var(--gap-md);display:flex;align-items:center;gap:var(--gap-sm);border-bottom:1px solid var(--border-subtle)}
.sidebar-logo{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--strava));border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:white;flex-shrink:0}
.sidebar-brand{font-weight:600;font-size:15px;white-space:nowrap;overflow:hidden;transition:opacity var(--transition-fast)}
.sidebar.collapsed .sidebar-brand{opacity:0;width:0}
.sidebar-nav{flex:1;padding:var(--gap-md) var(--gap-sm);overflow-y:auto}
.nav-section{margin-bottom:var(--gap-lg)}
.nav-section-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-tertiary);padding:var(--gap-sm);white-space:nowrap}
.sidebar.collapsed .nav-section-title{opacity:0;height:0;padding:0;overflow:hidden}
.nav-item{display:flex;align-items:center;gap:var(--gap-sm);padding:12px var(--gap-sm);border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;transition:all var(--transition-fast);margin-bottom:2px;position:relative;text-decoration:none}
.nav-item:hover{background:var(--bg-surface-hover);color:var(--text-primary)}
.nav-item.active{background:var(--accent-muted);color:var(--accent)}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:24px;background:var(--accent);border-radius:0 3px 3px 0}
.sidebar.collapsed .nav-item{justify-content:center;padding:12px}
.nav-item-icon{width:22px;height:22px;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.nav-item-icon svg{width:22px;height:22px}
.nav-item-text{white-space:nowrap;transition:opacity var(--transition-fast)}
.sidebar.collapsed .nav-item-text{opacity:0;width:0;position:absolute;pointer-events:none}
.sidebar-footer{padding:var(--gap-sm);border-top:1px solid var(--border-subtle)}
.sidebar-toggle{width:100%;padding:12px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:var(--gap-sm);transition:all var(--transition-fast)}
.sidebar-toggle:hover{background:var(--bg-surface-hover);color:var(--text-primary)}
.sidebar-toggle svg{transition:transform var(--transition-base)}
.sidebar.collapsed .sidebar-toggle svg{transform:rotate(180deg)}
.sidebar.collapsed .toggle-text{display:none}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
.sidebar-overlay.show{display:block}
.main-content{flex:1;margin-left:var(--sidebar-width);transition:margin-left var(--transition-base);min-height:100vh}
.sidebar.collapsed ~ .main-content{margin-left:var(--sidebar-collapsed)}
.topbar{height:var(--topbar-height);background:var(--bg-surface);border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 var(--gap-lg);position:sticky;top:0;z-index:50}
.topbar-left{display:flex;align-items:center;gap:var(--gap-md)}
.mobile-menu-btn{display:none;width:40px;height:40px;border-radius:var(--radius-sm);background:transparent;border:none;color:var(--text-primary);cursor:pointer;align-items:center;justify-content:center}
.page-title{font-size:18px;font-weight:600}
.topbar-right{display:flex;align-items:center;gap:var(--gap-sm)}
.topbar-btn{width:40px;height:40px;border-radius:var(--radius-sm);background:transparent;border:none;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition-fast)}
.topbar-btn:hover{background:var(--bg-surface-hover);color:var(--text-primary)}
.sync-btn{padding:8px 16px;background:var(--strava-muted);border:1px solid var(--strava);border-radius:var(--radius-sm);color:var(--strava);font-weight:500;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all var(--transition-fast)}
.sync-btn:hover{background:var(--strava);color:white}
.sync-btn.syncing{pointer-events:none;opacity:0.7}
.sync-btn.syncing svg{animation:spin 1s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.profile-btn{display:flex;align-items:center;gap:var(--gap-sm);padding:6px 12px 6px 6px;background:transparent;border:1px solid var(--border-color);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--transition-fast)}
.profile-btn:hover{background:var(--bg-surface-hover);border-color:var(--accent)}
.profile-avatar{width:28px;height:28px;border-radius:var(--radius-xs);background:var(--accent);color:white;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px}
.profile-name{color:var(--text-primary);font-size:14px;font-weight:500}
.page-content{padding:var(--gap-lg)}
.page-panel{display:none;animation:fadeIn var(--transition-base)}
.page-panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.section-header{margin-bottom:var(--gap-lg);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:var(--gap-sm)}
.section-title{font-size:20px;font-weight:600}
.section-subtitle{color:var(--text-secondary);font-size:13px;margin-top:2px}
.data-source{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-tertiary);background:var(--bg-surface);padding:6px 12px;border-radius:var(--radius-xs)}
.data-source svg{color:var(--strava)}
.status-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap-md);margin-bottom:var(--gap-lg)}
.stat-card{background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--card-padding);transition:all var(--transition-fast)}
.stat-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);border-color:var(--accent)}
.stat-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--gap-md)}
.stat-card-icon{width:40px;height:40px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center}
.stat-card-icon.runs{background:var(--accent-muted);color:var(--accent)}
.stat-card-icon.distance{background:var(--success-muted);color:var(--success)}
.stat-card-icon.time{background:var(--info-muted);color:var(--info)}
.stat-card-icon.elevation{background:var(--warning-muted);color:var(--warning)}
.stat-card-trend{font-size:12px;font-weight:500;padding:4px 8px;border-radius:var(--radius-xs)}
.stat-card-trend.up{background:var(--success-muted);color:var(--success)}
.stat-card-trend.neutral{background:var(--bg-surface-hover);color:var(--text-secondary)}
.stat-card-value{font-size:32px;font-weight:700;margin-bottom:var(--gap-xs)}
.stat-card-value span{font-size:18px;color:var(--text-secondary)}
.stat-card-label{color:var(--text-secondary);font-size:13px}
.tabs-section{background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-lg);overflow:hidden}
.tabs-header{display:flex;border-bottom:1px solid var(--border-color);padding:0 var(--gap-md)}
.tab-btn{padding:var(--gap-md);background:transparent;border:none;color:var(--text-secondary);font-size:14px;font-weight:500;cursor:pointer;position:relative;transition:color var(--transition-fast)}
.tab-btn:hover{color:var(--text-primary)}
.tab-btn.active{color:var(--accent)}
.tab-btn.active::after{content:'';position:absolute;bottom:0;left:var(--gap-md);right:var(--gap-md);height:2px;background:var(--accent)}
.tabs-content{padding:var(--card-padding)}
.tab-panel{display:none}
.tab-panel.active{display:block}
.activity-list{display:flex;flex-direction:column;gap:var(--gap-sm)}
.activity-item{display:flex;align-items:center;gap:var(--gap-md);padding:var(--gap-md);background:var(--bg-primary);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--transition-fast)}
.activity-item:hover{background:var(--bg-surface-hover)}
.activity-icon{width:44px;height:44px;border-radius:var(--radius-sm);background:var(--strava-muted);color:var(--strava);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.activity-info{flex:1;min-width:0}
.activity-name{font-weight:500;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.activity-meta{color:var(--text-secondary);font-size:13px}
.activity-stats{display:flex;gap:var(--gap-lg)}
.activity-stat{text-align:right}
.activity-stat-value{font-weight:600;font-size:15px}
.activity-stat-label{color:var(--text-tertiary);font-size:11px;text-transform:uppercase}
.insight-box{background:linear-gradient(135deg,var(--accent-muted) 0%,transparent 100%);border:1px solid var(--accent);border-radius:var(--radius-md);padding:var(--card-padding);margin-bottom:var(--gap-lg)}
.insight-header{display:flex;align-items:center;gap:var(--gap-sm);margin-bottom:var(--gap-md)}
.insight-badge{background:var(--accent);color:white;font-size:11px;font-weight:600;padding:4px 8px;border-radius:var(--radius-xs)}
.insight-title{font-size:18px;font-weight:600}
.insight-text{color:var(--text-secondary);line-height:1.6}
.maps-page{display:flex;gap:var(--gap-md);height:calc(100vh - var(--topbar-height) - 48px)}
.map-main{flex:1;position:relative;border-radius:var(--radius-lg);overflow:hidden;border:1px solid var(--border-color);background:#1a1a2e}
#map{width:100%;height:100%}
.map-overlay-stats{position:absolute;bottom:20px;left:20px;display:flex;gap:var(--gap-sm);z-index:5}
.map-badge{background:rgba(20,20,32,0.9);backdrop-filter:blur(8px);border:1px solid var(--border-color);border-radius:var(--radius-sm);padding:8px 14px;display:flex;align-items:center;gap:8px}
.map-badge-value{font-weight:700;font-size:18px;color:var(--accent)}
.map-badge-label{font-size:12px;color:var(--text-secondary)}
.map-overlay-controls{position:absolute;top:20px;left:20px;display:flex;flex-direction:column;gap:var(--gap-sm);z-index:5}
.map-btn{width:40px;height:40px;background:rgba(20,20,32,0.9);backdrop-filter:blur(8px);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition-fast)}
.map-btn:hover{background:var(--accent);border-color:var(--accent)}
.routes-sidebar{width:360px;display:flex;flex-direction:column;gap:var(--gap-md)}
.routes-info{background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--gap-md)}
.routes-info h3{margin-bottom:4px}
.routes-info p{font-size:13px;color:var(--text-secondary)}
.routes-list-card{flex:1;background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-md);display:flex;flex-direction:column;overflow:hidden}
.routes-list-header{padding:var(--gap-md);border-bottom:1px solid var(--border-color);font-weight:600}
.routes-list{flex:1;overflow-y:auto;padding:var(--gap-sm)}
.route-item{padding:var(--gap-md);margin-bottom:4px;background:var(--bg-primary);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--transition-fast);border-left:3px solid transparent}
.route-item:hover,.route-item.active{background:var(--accent-muted);border-left-color:var(--accent)}
.route-item-name{font-weight:500;margin-bottom:4px}
.route-item-meta{font-size:12px;color:var(--text-secondary);display:flex;gap:var(--gap-md)}
.route-detail{position:fixed;top:var(--topbar-height);right:-420px;width:400px;height:calc(100vh - var(--topbar-height));background:var(--bg-surface);border-left:1px solid var(--border-color);transition:right 0.3s ease;z-index:200;display:flex;flex-direction:column;box-shadow:-4px 0 20px rgba(0,0,0,0.3)}
.route-detail.open{right:0}
.route-detail-header{padding:var(--gap-lg);border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
.route-detail-title{font-size:18px;font-weight:600}
.close-btn{width:36px;height:36px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center}
.close-btn:hover{background:var(--bg-surface-hover);color:var(--text-primary)}
.route-detail-body{flex:1;padding:var(--gap-lg);overflow-y:auto}
.detail-stats{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap-md);margin-bottom:var(--gap-lg)}
.detail-stat{background:var(--bg-primary);border-radius:var(--radius-sm);padding:var(--gap-md);text-align:center}
.detail-stat-value{font-size:24px;font-weight:700;color:var(--accent)}
.detail-stat-label{font-size:12px;color:var(--text-secondary);margin-top:4px}
.detail-info{border-top:1px solid var(--border-color);padding-top:var(--gap-md)}
.detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border-subtle)}
.detail-label{color:var(--text-secondary)}
.detail-value{font-weight:500}
.strava-link{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:var(--gap-lg);padding:12px;background:var(--strava);color:white;border-radius:var(--radius-sm);text-decoration:none;font-weight:500;transition:opacity var(--transition-fast)}
.strava-link:hover{opacity:0.9}
.targets-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap-md);margin-bottom:var(--gap-lg)}
.target-card{background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--card-padding);position:relative;overflow:hidden}
.target-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
.target-card.runs::before{background:var(--accent)}
.target-card.distance::before{background:var(--success)}
.target-card.elevation::before{background:var(--warning)}
.target-header{display:flex;align-items:center;gap:var(--gap-sm);margin-bottom:var(--gap-md)}
.target-icon{width:44px;height:44px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center}
.target-icon.runs{background:var(--accent-muted);color:var(--accent)}
.target-icon.distance{background:var(--success-muted);color:var(--success)}
.target-icon.elevation{background:var(--warning-muted);color:var(--warning)}
.target-title{font-weight:600}
.target-subtitle{font-size:12px;color:var(--text-secondary)}
.target-pct{font-size:36px;font-weight:700;margin-bottom:var(--gap-sm)}
.target-bar{height:8px;background:var(--bg-primary);border-radius:4px;overflow:hidden;margin-bottom:var(--gap-sm)}
.target-fill{height:100%;border-radius:4px;transition:width 0.5s ease}
.target-fill.runs{background:var(--accent)}
.target-fill.distance{background:var(--success)}
.target-fill.elevation{background:var(--warning)}
.target-values{display:flex;justify-content:space-between;font-size:13px}
.target-current{font-weight:600}
.target-goal{color:var(--text-secondary)}
.calendar-card{background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-lg);overflow:hidden}
.calendar-header{padding:var(--gap-md) var(--card-padding);border-bottom:1px solid var(--border-color)}
.calendar-title{font-weight:600}
.calendar-body{padding:var(--card-padding)}
.calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:var(--gap-sm)}
.calendar-weekday{text-align:center;font-size:12px;font-weight:500;color:var(--text-tertiary);padding:8px}
.calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:var(--radius-sm);font-size:14px;background:var(--bg-primary);cursor:pointer;transition:all var(--transition-fast);position:relative}
.cal-day:hover{background:var(--bg-surface-hover)}
.cal-day.other{opacity:0.3}
.cal-day.today{border:2px solid var(--accent)}
.cal-day.has-run{background:var(--success-muted)}
.cal-day.has-run::after{content:'';width:6px;height:6px;background:var(--success);border-radius:50%;position:absolute;bottom:4px}
.cal-day-num{font-weight:500}
.calendar-legend{display:flex;gap:var(--gap-lg);padding:var(--gap-md) var(--card-padding);border-top:1px solid var(--border-color)}
.legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary)}
.legend-dot{width:10px;height:10px;border-radius:50%}
.chat-fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:var(--accent);border:none;color:white;cursor:pointer;box-shadow:var(--shadow-lg);display:flex;align-items:center;justify-content:center;z-index:300;transition:transform var(--transition-fast)}
.chat-fab:hover{transform:scale(1.05);background:var(--accent-hover)}
.chat-panel{position:fixed;bottom:96px;right:24px;width:380px;max-height:500px;background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);display:none;flex-direction:column;z-index:300;overflow:hidden}
.chat-panel.show{display:flex}
.chat-header{padding:var(--gap-md);border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
.chat-title{font-weight:600;display:flex;align-items:center;gap:var(--gap-sm)}
.chat-badge{background:var(--accent);color:white;font-size:10px;padding:2px 6px;border-radius:var(--radius-xs)}
.chat-close{width:32px;height:32px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;border-radius:var(--radius-xs);display:flex;align-items:center;justify-content:center}
.chat-close:hover{background:var(--bg-surface-hover)}
.chat-messages{flex:1;overflow-y:auto;padding:var(--gap-md);display:flex;flex-direction:column;gap:var(--gap-sm);min-height:280px;max-height:350px}
.chat-msg{max-width:85%;padding:10px 14px;border-radius:var(--radius-md);font-size:14px;line-height:1.5;word-wrap:break-word}
.chat-msg.bot{background:var(--bg-primary);align-self:flex-start}
.chat-msg.user{background:var(--accent);color:white;align-self:flex-end}
.chat-msg.loading{display:flex;gap:4px;padding:14px}
.chat-msg.loading span{width:8px;height:8px;background:var(--text-tertiary);border-radius:50%;animation:bounce 1.4s infinite}
.chat-msg.loading span:nth-child(2){animation-delay:0.2s}
.chat-msg.loading span:nth-child(3){animation-delay:0.4s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-8px)}}
.chat-input-row{padding:var(--gap-md);border-top:1px solid var(--border-color);display:flex;gap:var(--gap-sm)}
.chat-input{flex:1;padding:12px;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:14px;outline:none}
.chat-input:focus{border-color:var(--accent)}
.chat-send{width:44px;height:44px;border-radius:var(--radius-sm);background:var(--accent);border:none;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.chat-send:hover{background:var(--accent-hover)}
.chat-send:disabled{opacity:0.5;cursor:not-allowed}
.dropdown{position:relative}
.dropdown-menu{position:absolute;top:100%;right:0;margin-top:var(--gap-sm);min-width:180px;background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);opacity:0;visibility:hidden;transform:translateY(-8px);transition:all var(--transition-fast);z-index:100}
.dropdown.open .dropdown-menu{opacity:1;visibility:visible;transform:translateY(0)}
.dropdown-item{display:flex;align-items:center;gap:var(--gap-sm);padding:10px var(--gap-md);color:var(--text-primary);font-size:14px;cursor:pointer}
.dropdown-item:hover{background:var(--bg-surface-hover)}
.dropdown-divider{height:1px;background:var(--border-color);margin:4px 0}
.toast-container{position:fixed;top:80px;right:24px;z-index:1000;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--bg-surface);border:1px solid var(--border-color);border-left:3px solid var(--strava);border-radius:var(--radius-sm);padding:var(--gap-md);box-shadow:var(--shadow-lg);animation:slideIn 0.3s ease;min-width:260px}
.toast.success{border-left-color:var(--success)}
.toast.error{border-left-color:var(--error)}
@keyframes slideIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
.coming-soon{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:400px;text-align:center;padding:var(--gap-lg)}
.coming-soon-icon{width:80px;height:80px;border-radius:var(--radius-lg);background:var(--accent-muted);color:var(--accent);display:flex;align-items:center;justify-content:center;margin-bottom:var(--gap-lg)}
.coming-soon-title{font-size:24px;font-weight:600;margin-bottom:var(--gap-sm)}
.coming-soon-text{color:var(--text-secondary);max-width:400px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--gap-sm);padding:10px 16px;font-size:14px;font-weight:500;border-radius:var(--radius-sm);border:none;cursor:pointer;transition:all var(--transition-fast)}
.btn-primary{background:var(--accent);color:white}
.btn-primary:hover{background:var(--accent-hover)}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
@media(max-width:1200px){.status-grid,.targets-grid{grid-template-columns:repeat(2,1fr)}.maps-page{flex-direction:column;height:auto}.map-main{min-height:500px}.routes-sidebar{width:100%}}
@media(max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.mobile-open{transform:translateX(0)}.main-content{margin-left:0}.mobile-menu-btn{display:flex}.status-grid,.targets-grid{grid-template-columns:1fr}.routes-sidebar{display:none}.route-detail{width:100%;right:-100%}.chat-panel{width:calc(100% - 48px);right:24px;bottom:96px}}
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>
    <div class="app-container">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo" aria-hidden="true">TI</div>
                <span class="sidebar-brand">Training Intel</span>
            </div>
            <nav class="sidebar-nav" aria-label="Main navigation">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a class="nav-item active" data-page="dashboard" href="#dashboard" role="button" aria-current="page">
                        <span class="nav-item-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></span>
                        <span class="nav-item-text">Dashboard</span>
                    </a>
                    <a class="nav-item" data-page="maps" href="#maps" role="button">
                        <span class="nav-item-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg></span>
                        <span class="nav-item-text">Maps</span>
                    </a>
                    <a class="nav-item" data-page="predictions" href="#predictions" role="button">
                        <span class="nav-item-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>
                        <span class="nav-item-text">Predictions</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Health</div>
                    <a class="nav-item" data-page="health" href="#health" role="button">
                        <span class="nav-item-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></span>
                        <span class="nav-item-text">Health</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Insights</div>
                    <a class="nav-item" data-page="ai" href="#ai" role="button">
                        <span class="nav-item-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg></span>
                        <span class="nav-item-text">AI Coach</span>
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/></svg>
                    <span class="toggle-text">Collapse</span>
                </button>
            </div>
        </aside>
        <main class="main-content" id="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Open menu">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    </button>
                    <h1 class="page-title" id="page-title">Dashboard</h1>
                </div>
                <div class="topbar-right">
                    <button class="sync-btn" id="sync-btn" aria-label="Sync with Strava">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        <span>Sync Strava</span>
                    </button>
                    <button class="topbar-btn" id="theme-toggle" aria-label="Toggle theme">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/></svg>
                    </button>
                    <div class="dropdown" id="profileDropdown">
                        <button class="profile-btn" id="profile-btn" aria-haspopup="true" aria-expanded="false">
                            <div class="profile-avatar" aria-hidden="true">AV</div>
                            <span class="profile-name">Alex Volo</span>
                        </button>
                        <div class="dropdown-menu" role="menu">
                            <div class="dropdown-item" role="menuitem">Settings</div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" role="menuitem" id="logout-btn">Logout</div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="page-content">
                <!-- Dashboard Page -->
                <section class="page-panel active" id="page-dashboard" aria-labelledby="page-title">
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">January 2026 Summary</h2>
                            <p class="section-subtitle" id="today-date"></p>
                        </div>
                        <div class="data-source">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066l-2.084 4.116z"/><path d="M15.387 0l-5.153 10.172h3.066l2.087-4.116 2.089 4.116h3.065L15.387 0z" opacity=".6"/></svg>
                            <span>Strava Data</span>
                        </div>
                    </div>
                    <div class="status-grid" role="list">
                        <article class="stat-card" role="listitem">
                            <div class="stat-card-header">
                                <div class="stat-card-icon runs" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                                <span class="stat-card-trend up">Jan 2026</span>
                            </div>
                            <div class="stat-card-value" id="stat-runs">11</div>
                            <div class="stat-card-label">Total Runs</div>
                        </article>
                        <article class="stat-card" role="listitem">
                            <div class="stat-card-header">
                                <div class="stat-card-icon distance" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
                                <span class="stat-card-trend up">Strong</span>
                            </div>
                            <div class="stat-card-value" id="stat-distance">120.4<span>km</span></div>
                            <div class="stat-card-label">Total Distance</div>
                        </article>
                        <article class="stat-card" role="listitem">
                            <div class="stat-card-header">
                                <div class="stat-card-icon time" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                                <span class="stat-card-trend neutral">Total</span>
                            </div>
                            <div class="stat-card-value" id="stat-time">10:37<span>hrs</span></div>
                            <div class="stat-card-label">Total Time</div>
                        </article>
                        <article class="stat-card" role="listitem">
                            <div class="stat-card-header">
                                <div class="stat-card-icon elevation" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></svg></div>
                                <span class="stat-card-trend up">Climbing</span>
                            </div>
                            <div class="stat-card-value" id="stat-elevation">420<span>m</span></div>
                            <div class="stat-card-label">Total Elevation</div>
                        </article>
                    </div>
                    <div class="tabs-section">
                        <div class="tabs-header" role="tablist">
                            <button class="tab-btn active" data-tab="recent" role="tab" aria-selected="true" aria-controls="tab-recent">Recent Activities</button>
                            <button class="tab-btn" data-tab="insights" role="tab" aria-selected="false" aria-controls="tab-insights">AI Insights</button>
                        </div>
                        <div class="tabs-content">
                            <div class="tab-panel active" id="tab-recent" role="tabpanel">
                                <div class="activity-list" id="activity-list"></div>
                            </div>
                            <div class="tab-panel" id="tab-insights" role="tabpanel">
                                <div class="insight-box">
                                    <div class="insight-header">
                                        <span class="insight-badge">AI</span>
                                        <span class="insight-title">Great Progress!</span>
                                    </div>
                                    <p class="insight-text" id="ai-insight"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Maps Page -->
                <section class="page-panel" id="page-maps">
                    <div class="maps-page">
                        <div class="map-main">
                            <div id="map" role="img" aria-label="Running routes map"></div>
                            <div class="map-overlay-controls">
                                <button class="map-btn" id="fit-routes-btn" aria-label="Fit all routes">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                                </button>
                                <button class="map-btn" id="toggle-style-btn" aria-label="Toggle map style">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                                </button>
                            </div>
                            <div class="map-overlay-stats">
                                <div class="map-badge"><span class="map-badge-value" id="map-stat-routes">11</span><span class="map-badge-label">routes</span></div>
                                <div class="map-badge"><span class="map-badge-value" id="map-stat-km">120.4</span><span class="map-badge-label">km</span></div>
                            </div>
                        </div>
                        <div class="routes-sidebar">
                            <div class="routes-info"><h3>Running Maps</h3><p>Real GPS data from Strava</p></div>
                            <div class="routes-list-card">
                                <div class="routes-list-header">January 2026</div>
                                <div class="routes-list" id="routes-list" role="list"></div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Predictions Page -->
                <section class="page-panel" id="page-predictions">
                    <div class="section-header"><h2 class="section-title">January Targets</h2></div>
                    <div class="targets-grid" id="targets-grid" role="list"></div>
                    <div class="insight-box" id="targets-insight"></div>
                    <div class="calendar-card">
                        <div class="calendar-header"><div class="calendar-title">January 2026</div></div>
                        <div class="calendar-body">
                            <div class="calendar-weekdays"><div class="calendar-weekday">Mon</div><div class="calendar-weekday">Tue</div><div class="calendar-weekday">Wed</div><div class="calendar-weekday">Thu</div><div class="calendar-weekday">Fri</div><div class="calendar-weekday">Sat</div><div class="calendar-weekday">Sun</div></div>
                            <div class="calendar-days" id="calendar-days" role="grid"></div>
                        </div>
                        <div class="calendar-legend"><div class="legend-item"><div class="legend-dot" style="background:var(--success)" aria-hidden="true"></div>Run</div><div class="legend-item"><div class="legend-dot" style="background:var(--accent)" aria-hidden="true"></div>Today</div></div>
                    </div>
                </section>
                <!-- Health Page -->
                <section class="page-panel" id="page-health">
                    <div class="coming-soon">
                        <div class="coming-soon-icon" aria-hidden="true"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></div>
                        <h2 class="coming-soon-title">Health Metrics</h2>
                        <p class="coming-soon-text">Coming soon</p>
                    </div>
                </section>
                <!-- AI Page -->
                <section class="page-panel" id="page-ai">
                    <div class="coming-soon">
                        <div class="coming-soon-icon" aria-hidden="true"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/></svg></div>
                        <h2 class="coming-soon-title">AI Coach</h2>
                        <p class="coming-soon-text">Your running assistant</p>
                        <button class="btn btn-primary" id="open-chat-btn" style="margin-top:20px">Open Chat</button>
                    </div>
                </section>
            </div>
        </main>
    </div>
    <!-- Route Detail Panel -->
    <aside class="route-detail" id="route-detail" aria-label="Route details">
        <div class="route-detail-header">
            <div class="route-detail-title" id="detail-title">Route</div>
            <button class="close-btn" id="close-detail-btn" aria-label="Close details">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="route-detail-body">
            <div class="detail-stats">
                <div class="detail-stat"><div class="detail-stat-value" id="d-dist">-</div><div class="detail-stat-label">Distance</div></div>
                <div class="detail-stat"><div class="detail-stat-value" id="d-pace">-</div><div class="detail-stat-label">Pace</div></div>
                <div class="detail-stat"><div class="detail-stat-value" id="d-time">-</div><div class="detail-stat-label">Time</div></div>
                <div class="detail-stat"><div class="detail-stat-value" id="d-hr">-</div><div class="detail-stat-label">HR</div></div>
            </div>
            <div class="detail-info">
                <div class="detail-row"><span class="detail-label">Date</span><span class="detail-value" id="d-date">-</span></div>
                <div class="detail-row"><span class="detail-label">Max HR</span><span class="detail-value" id="d-maxhr">-</span></div>
                <div class="detail-row"><span class="detail-label">Elevation</span><span class="detail-value" id="d-elev">-</span></div>
                <div class="detail-row"><span class="detail-label">Calories</span><span class="detail-value" id="d-cal">-</span></div>
            </div>
            <a class="strava-link" id="strava-link" href="#" target="_blank" rel="noopener noreferrer">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066l-2.084 4.116z"/><path d="M15.387 0l-5.153 10.172h3.066l2.087-4.116 2.089 4.116h3.065L15.387 0z" opacity=".6"/></svg>
                View on Strava
            </a>
        </div>
    </aside>
    <!-- Chat FAB & Panel -->
    <button class="chat-fab" id="chat-fab" aria-label="Open chat">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    </button>
    <div class="chat-panel" id="chat-panel" role="dialog" aria-label="AI Coach chat">
        <div class="chat-header">
            <div class="chat-title">Running Coach <span class="chat-badge">AI</span></div>
            <button class="chat-close" id="chat-close" aria-label="Close chat">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="chat-messages" id="chat-messages" role="log" aria-live="polite">
            <div class="chat-msg bot">Hi! I'm your AI running coach with access to your Strava data.</div>
        </div>
        <div class="chat-input-row">
            <input type="text" class="chat-input" id="chat-input" placeholder="Ask anything..." aria-label="Chat message">
            <button class="chat-send" id="chat-send" aria-label="Send message">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
        </div>
    </div>
    // ============== NAVIGATION ==============
    function navigateTo(page) {
        state.currentPage = page;
        
        $$('.nav-item').forEach(item => {
            const isActive = item.dataset.page === page;
            item.classList.toggle('active', isActive);
            item.setAttribute('aria-current', isActive ? 'page' : 'false');
        });

        $$('.page-panel').forEach(panel => panel.classList.remove('active'));
        $(`page-${page}`)?.classList.add('active');

        const titles = { dashboard: 'Dashboard', maps: 'Running Maps', predictions: 'Predictions', health: 'Health', ai: 'AI Coach' };
        safeSetText('page-title', titles[page] || 'Dashboard');

        closeMobileSidebar();
        closeRouteDetail();

        if (page === 'maps') setTimeout(initMap, 200);
        if (page === 'predictions') { updateTargets(); renderCalendar(); }
    }

    // ============== UI CONTROLS ==============
    function toggleSidebar() {
        $('sidebar')?.classList.toggle('collapsed');
    }

    function openMobileSidebar() {
        $('sidebar')?.classList.add('mobile-open');
        $('sidebar-overlay')?.classList.add('show');
    }

    function closeMobileSidebar() {
        $('sidebar')?.classList.remove('mobile-open');
        $('sidebar-overlay')?.classList.remove('show');
    }

    function toggleTheme() {
        const html = document.documentElement;
        const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        try { localStorage.setItem('theme', newTheme); } catch (e) {}
    }

    function toggleProfileDropdown() {
        const dropdown = $('profileDropdown');
        if (!dropdown) return;
        const isOpen = dropdown.classList.toggle('open');
        $('profile-btn')?.setAttribute('aria-expanded', isOpen);
    }

    function toggleChat() {
        const panel = $('chat-panel');
        if (!panel) return;
        const isOpen = panel.classList.toggle('show');
        if (isOpen) $('chat-input')?.focus();
    }

    // ============== CHAT ==============
    function addChatMessage(text, type) {
        const container = $('chat-messages');
        if (!container) return null;

        const msg = document.createElement('div');
        msg.className = `chat-msg ${type}`;
        msg.textContent = text;
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;
        return msg;
    }

    function addLoadingMessage() {
        const container = $('chat-messages');
        if (!container) return null;

        const msg = document.createElement('div');
        msg.className = 'chat-msg bot loading';
        msg.innerHTML = '<span></span><span></span><span></span>';
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;
        return msg;
    }

    async function sendMessage() {
        const input = $('chat-input');
        if (!input) return;

        const message = input.value.trim();
        if (!message || state.isTyping) return;

        addChatMessage(message, 'user');
        input.value = '';
        state.isTyping = true;
        $('chat-send')?.setAttribute('disabled', 'true');

        const loading = addLoadingMessage();
        const stats = calcStats();

        try {
            const response = await fetch(CONFIG.GROQ.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.GROQ.API_KEY}`
                },
                body: JSON.stringify({
                    model: CONFIG.GROQ.MODEL,
                    messages: [
                        { role: 'system', content: `You are a running coach. The user has ${stats.runs} runs in January, ${stats.distance}km total, ${stats.elevation}m elevation. Be concise and helpful.` },
                        { role: 'user', content: message }
                    ],
                    max_tokens: 300,
                    temperature: 0.7
                })
            });

            loading?.remove();

            if (!response.ok) throw new Error('API request failed');

            const data = await response.json();
            const reply = data.choices?.[0]?.message?.content || 'Sorry, I could not process that.';
            addChatMessage(reply, 'bot');
        } catch (e) {
            loading?.remove();
            addChatMessage('Connection error. Please try again.', 'bot');
            console.error('Chat error:', e);
        } finally {
            state.isTyping = false;
            $('chat-send')?.removeAttribute('disabled');
        }
    }

    // ============== EVENT LISTENERS ==============
    function initEventListeners() {
        // Navigation
        $$('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(item.dataset.page);
            });
        });

        // Sidebar
        $('sidebar-toggle')?.addEventListener('click', toggleSidebar);
        $('mobile-menu-btn')?.addEventListener('click', openMobileSidebar);
        $('sidebar-overlay')?.addEventListener('click', closeMobileSidebar);

        // Theme & Profile
        $('theme-toggle')?.addEventListener('click', toggleTheme);
        $('profile-btn')?.addEventListener('click', toggleProfileDropdown);
        $('logout-btn')?.addEventListener('click', () => location.reload());

        // Strava sync
        $('sync-btn')?.addEventListener('click', syncStrava);

        // Map controls
        $('fit-routes-btn')?.addEventListener('click', fitAllRoutes);
        $('toggle-style-btn')?.addEventListener('click', toggleMapStyle);

        // Route detail
        $('close-detail-btn')?.addEventListener('click', closeRouteDetail);

        // Activity list clicks (delegated)
        $('activity-list')?.addEventListener('click', (e) => {
            const item = e.target.closest('.activity-item');
            if (item) {
                const id = parseInt(item.dataset.id);
                const route = ROUTES.find(r => r.id === id);
                if (route) {
                    navigateTo('maps');
                    setTimeout(() => openRouteDetail(route), 300);
                }
            }
        });

        // Routes list clicks (delegated)
        $('routes-list')?.addEventListener('click', (e) => {
            const item = e.target.closest('.route-item');
            if (item) {
                const id = parseInt(item.dataset.id);
                const route = ROUTES.find(r => r.id === id);
                if (route) openRouteDetail(route);
            }
        });

        // Chat
        $('chat-fab')?.addEventListener('click', toggleChat);
        $('chat-close')?.addEventListener('click', toggleChat);
        $('open-chat-btn')?.addEventListener('click', toggleChat);
        $('chat-send')?.addEventListener('click', sendMessage);
        $('chat-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Tabs
        $$('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                $$('.tab-btn').forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-selected', 'false');
                });
                $$('.tab-panel').forEach(p => p.classList.remove('active'));
                
                btn.classList.add('active');
                btn.setAttribute('aria-selected', 'true');
                $(`tab-${btn.dataset.tab}`)?.classList.add('active');
            });
        });

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                $('chat-panel')?.classList.remove('show');
                closeRouteDetail();
                closeMobileSidebar();
                $('profileDropdown')?.classList.remove('open');
            }
        });

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            const dropdown = $('profileDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
                $('profile-btn')?.setAttribute('aria-expanded', 'false');
            }
        });
    }

    // ============== INITIALIZATION ==============
    function init() {
        // Apply saved theme
        try {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
        } catch (e) {}

        // Set today's date
        const dateEl = $('today-date');
        if (dateEl) {
            dateEl.textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
        }

        // Initialize components
        updateDashboard();
        initEventListeners();

        // Handle hash navigation
        const hash = window.location.hash.slice(1);
        if (hash && ['dashboard', 'maps', 'predictions', 'health', 'ai'].includes(hash)) {
            navigateTo(hash);
        }
    }

    // Start app when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
</body>
</html>
