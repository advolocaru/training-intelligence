<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Training Intelligence - Your personal running dashboard">
    <meta name="theme-color" content="#8b5cf6">
    <title>Training Intelligence - Athlete Performance Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
:root{--bg-primary:#0a0a0f;--bg-surface:#141420;--bg-surface-hover:#1a1a2e;--bg-elevated:#1e1e30;--border-color:#2a2a3e;--border-subtle:#1f1f2e;--text-primary:#f5f5f7;--text-secondary:#8888a0;--text-tertiary:#5a5a70;--accent:#8b5cf6;--accent-hover:#a78bfa;--accent-muted:rgba(139,92,246,0.15);--success:#22c55e;--success-muted:rgba(34,197,94,0.15);--warning:#eab308;--warning-muted:rgba(234,179,8,0.15);--error:#ef4444;--error-muted:rgba(239,68,68,0.15);--info:#3b82f6;--info-muted:rgba(59,130,246,0.15);--strava:#fc4c02;--strava-muted:rgba(252,76,2,0.15);--sleep:#a855f7;--sleep-muted:rgba(168,85,247,0.15);--sidebar-width:240px;--sidebar-collapsed:72px;--topbar-height:64px;--card-padding:24px;--gap-lg:24px;--gap-md:16px;--gap-sm:8px;--gap-xs:4px;--radius-lg:16px;--radius-md:12px;--radius-sm:8px;--radius-xs:6px;--shadow-md:0 4px 12px rgba(0,0,0,0.4);--shadow-lg:0 8px 24px rgba(0,0,0,0.5);--transition-fast:150ms ease;--transition-base:200ms ease}
[data-theme="light"]{--bg-primary:#f5f5f7;--bg-surface:#ffffff;--bg-surface-hover:#f0f0f5;--bg-elevated:#ffffff;--border-color:#e5e5ea;--border-subtle:#ebebf0;--text-primary:#1a1a2e;--text-secondary:#6b6b80;--text-tertiary:#9898a8;--accent:#7c3aed;--accent-hover:#6d28d9;--accent-muted:rgba(124,58,237,0.1);--shadow-md:0 4px 12px rgba(0,0,0,0.08);--shadow-lg:0 8px 24px rgba(0,0,0,0.12)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);font-size:14px;line-height:1.5;overflow-x:hidden}
.app-container{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-width);height:100vh;position:fixed;left:0;top:0;background:var(--bg-surface);border-right:1px solid var(--border-color);display:flex;flex-direction:column;transition:width var(--transition-base);z-index:100}
.sidebar.collapsed{width:var(--sidebar-collapsed)}
.sidebar-header{height:var(--topbar-height);padding:0 var(--gap-md);display:flex;align-items:center;gap:var(--gap-sm);border-bottom:1px solid var(--border-subtle)}
.sidebar-logo{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--strava));border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:white;flex-shrink:0}
.sidebar-brand{font-weight:600;font-size:15px;white-space:nowrap;overflow:hidden;transition:opacity var(--transition-fast)}
.sidebar.collapsed .sidebar-brand{opacity:0;width:0}
.sidebar-nav{flex:1;padding:var(--gap-md) var(--gap-sm);overflow-y:auto}
.nav-section{margin-bottom:var(--gap-lg)}
.nav-section-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-tertiary);padding:var(--gap-sm);white-space:nowrap}
.sidebar.collapsed .nav-section-title{opacity:0;height:0;padding:0;overflow:hidden}
.nav-item{display:flex;align-items:center;gap:var(--gap-sm);padding:12px var(--gap-sm);border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;transition:all var(--transition-fast);margin-bottom:2px;position:relative;text-decoration:none}
.nav-item:hover{background:var(--bg-surface-hover);color:var(--text-primary)}
.nav-item.active{background:var(--accent-muted);color:var(--accent)}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:24px;background:var(--accent);border-radius:0 3px 3px 0}
.sidebar.collapsed .nav-item{justify-content:center;padding:12px}
.nav-item-icon{width:22px;height:22px;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.nav-item-icon svg{width:22px;height:22px}
.nav-item-text{white-space:nowrap;transition:opacity var(--transition-fast)}
.sidebar.collapsed .nav-item-text{opacity:0;width:0;position:absolute;pointer-events:none}
.sidebar-footer{padding:var(--gap-sm);border-top:1px solid var(--border-subtle)}
.sidebar-toggle{width:100%;padding:12px;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:var(--gap-sm);transition:all var(--transition-fast)}
.sidebar-toggle:hover{background:var(--bg-surface-hover);color:var(--text-primary)}
.sidebar-toggle svg{transition:transform var(--transition-base)}
.sidebar.collapsed .sidebar-toggle svg{transform:rotate(180deg)}
.sidebar.collapsed .toggle-text{display:none}
.main-content{flex:1;margin-left:var(--sidebar-width);transition:margin-left var(--transition-base);min-height:100vh}
.sidebar.collapsed ~ .main-content{margin-left:var(--sidebar-collapsed)}
.topbar{height:var(--topbar-height);background:var(--bg-surface);border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 var(--gap-lg);position:sticky;top:0;z-index:50}
.topbar-left{display:flex;align-items:center;gap:var(--gap-md)}
.page-title{font-size:18px;font-weight:600}
.topbar-right{display:flex;align-items:center;gap:var(--gap-sm)}
.topbar-btn{width:40px;height:40px;border-radius:var(--radius-sm);background:transparent;border:none;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition-fast)}
.topbar-btn:hover{background:var(--bg-surface-hover);color:var(--text-primary)}
.sync-btn{padding:8px 16px;background:var(--strava-muted);border:1px solid var(--strava);border-radius:var(--radius-sm);color:var(--strava);font-weight:500;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all var(--transition-fast)}
.sync-btn:hover{background:var(--strava);color:white}
.sync-btn.syncing{pointer-events:none;opacity:0.7}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.sync-btn.syncing svg{animation:spin 1s linear infinite}
.page-content{padding:var(--gap-lg)}
.page-panel{display:none;animation:fadeIn var(--transition-base)}
.page-panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.section-header{margin-bottom:var(--gap-lg);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:var(--gap-sm)}
.section-title{font-size:20px;font-weight:600}
.section-subtitle{color:var(--text-secondary);font-size:13px;margin-top:2px}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap-md);margin-bottom:var(--gap-lg)}
.stat-card{background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--card-padding);transition:all var(--transition-fast)}
.stat-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);border-color:var(--accent)}
.stat-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--gap-md)}
.stat-card-icon{width:40px;height:40px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center}
.stat-card-icon.runs{background:var(--accent-muted);color:var(--accent)}
.stat-card-icon.distance{background:var(--success-muted);color:var(--success)}
.stat-card-icon.time{background:var(--info-muted);color:var(--info)}
.stat-card-icon.elevation{background:var(--warning-muted);color:var(--warning)}
.stat-card-value{font-size:32px;font-weight:700;margin-bottom:var(--gap-xs)}
.stat-card-value span{font-size:18px;color:var(--text-secondary)}
.stat-card-label{color:var(--text-secondary);font-size:13px}
.health-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap-md);margin-bottom:var(--gap-lg)}
.health-card{background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--card-padding)}
.health-card-icon{width:48px;height:48px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;margin-bottom:var(--gap-md)}
.health-card-icon.sleep{background:var(--sleep-muted);color:var(--sleep)}
.health-card-icon.stress{background:var(--error-muted);color:var(--error)}
.health-card-icon.steps{background:var(--success-muted);color:var(--success)}
.health-card-icon.hrv{background:var(--info-muted);color:var(--info)}
.health-card-value{font-size:28px;font-weight:700;margin-bottom:4px}
.health-card-label{color:var(--text-secondary);font-size:13px;margin-bottom:var(--gap-sm)}
.health-card-sub{font-size:12px;color:var(--text-tertiary)}
.chart-card{background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-md);padding:var(--card-padding);margin-bottom:var(--gap-lg)}
.chart-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--gap-md)}
.chart-card-title{font-weight:600}
.chart-container{height:250px;position:relative}
.activity-list{display:flex;flex-direction:column;gap:var(--gap-sm)}
.activity-item{display:flex;align-items:center;gap:var(--gap-md);padding:var(--gap-md);background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--transition-fast)}
.activity-item:hover{background:var(--bg-surface-hover);border-color:var(--accent)}
.activity-icon{width:44px;height:44px;border-radius:var(--radius-sm);background:var(--accent-muted);color:var(--accent);display:flex;align-items:center;justify-content:center}
.activity-info{flex:1}
.activity-name{font-weight:500;margin-bottom:2px}
.activity-meta{font-size:12px;color:var(--text-secondary)}
.activity-stats{display:flex;gap:var(--gap-lg);text-align:right}
.activity-stat-value{font-weight:600}
.activity-stat-label{font-size:11px;color:var(--text-tertiary)}
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--text-secondary)}
.loading-spinner{width:24px;height:24px;border:3px solid var(--border-color);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-right:12px}
.map-container{height:500px;border-radius:var(--radius-md);overflow:hidden;background:var(--bg-surface);border:1px solid var(--border-color)}
#map{width:100%;height:100%}
.routes-sidebar{width:320px;background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius-md);margin-left:var(--gap-md);display:flex;flex-direction:column;max-height:500px}
.routes-header{padding:var(--gap-md);border-bottom:1px solid var(--border-color);font-weight:600}
.routes-list{flex:1;overflow-y:auto;padding:var(--gap-sm)}
.route-item{padding:var(--gap-sm) var(--gap-md);margin-bottom:4px;background:var(--bg-primary);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--transition-fast);border-left:3px solid transparent}
.route-item:hover,.route-item.active{background:var(--accent-muted);border-left-color:var(--accent)}
.route-item-name{font-weight:500;font-size:13px;margin-bottom:2px}
.route-item-meta{font-size:11px;color:var(--text-secondary);display:flex;gap:var(--gap-md)}
.map-layout{display:flex}
.flex-1{flex:1}
@media(max-width:1200px){.stats-grid,.health-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.stats-grid,.health-grid{grid-template-columns:1fr}.sidebar{transform:translateX(-100%)}.sidebar.mobile-open{transform:translateX(0)}.main-content{margin-left:0!important}.map-layout{flex-direction:column}.routes-sidebar{width:100%;margin-left:0;margin-top:var(--gap-md);max-height:300px}}
</style>
</head>
<body>
<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">TI</div>
            <span class="sidebar-brand">Training Intelligence</span>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <a class="nav-item active" data-page="dashboard"><span class="nav-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></span><span class="nav-item-text">Dashboard</span></a>
                <a class="nav-item" data-page="maps"><span class="nav-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg></span><span class="nav-item-text">Maps</span></a>
                <a class="nav-item" data-page="health"><span class="nav-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></span><span class="nav-item-text">Health</span></a>
            </div>
        </nav>
        <div class="sidebar-footer">
            <button class="sidebar-toggle" id="sidebar-toggle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg><span class="toggle-text">Collapse</span></button>
        </div>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <div class="topbar-left">
                <h1 class="page-title" id="page-title">Dashboard</h1>
            </div>
            <div class="topbar-right">
                <button class="sync-btn" id="sync-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg><span>Sync Strava</span></button>
                <button class="topbar-btn" id="theme-toggle" title="Toggle theme"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
            </div>
        </header>

        <div class="page-content">
            <!-- Dashboard Page -->
            <div class="page-panel active" id="page-dashboard">
                <div class="section-header">
                    <div><h2 class="section-title">Running Overview</h2><p class="section-subtitle">Your all-time running statistics</p></div>
                </div>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon runs"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div></div><div class="stat-card-value" id="stat-runs">--</div><div class="stat-card-label">Total Runs</div></div>
                    <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon distance"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div></div><div class="stat-card-value" id="stat-distance">--<span>km</span></div><div class="stat-card-label">Total Distance</div></div>
                    <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon time"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div></div><div class="stat-card-value" id="stat-time">--<span>hrs</span></div><div class="stat-card-label">Total Time</div></div>
                    <div class="stat-card"><div class="stat-card-header"><div class="stat-card-icon elevation"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 20l8-16 4 8 6-6"/></svg></div></div><div class="stat-card-value" id="stat-elevation">--<span>m</span></div><div class="stat-card-label">Total Elevation</div></div>
                </div>
                
                <div class="section-header"><h2 class="section-title">Recent Activities</h2></div>
                <div class="activity-list" id="activity-list"><div class="loading"><div class="loading-spinner"></div>Loading activities...</div></div>
            </div>

            <!-- Maps Page -->
            <div class="page-panel" id="page-maps">
                <div class="section-header"><h2 class="section-title">Running Routes</h2></div>
                <div class="map-layout">
                    <div class="flex-1"><div class="map-container"><div id="map"></div></div></div>
                    <div class="routes-sidebar">
                        <div class="routes-header">All Routes (<span id="routes-count">0</span>)</div>
                        <div class="routes-list" id="routes-list"><div class="loading"><div class="loading-spinner"></div>Loading...</div></div>
                    </div>
                </div>
            </div>

            <!-- Health Page -->
            <div class="page-panel" id="page-health">
                <div class="section-header">
                    <div><h2 class="section-title">Health & Recovery</h2><p class="section-subtitle">Data from Garmin Connect</p></div>
                </div>
                <div class="health-grid" id="health-grid">
                    <div class="health-card"><div class="health-card-icon sleep"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></div><div class="health-card-value" id="health-sleep">--</div><div class="health-card-label">Sleep (last night)</div><div class="health-card-sub" id="health-sleep-detail">Deep: -- | REM: --</div></div>
                    <div class="health-card"><div class="health-card-icon stress"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/></svg></div><div class="health-card-value" id="health-stress">--</div><div class="health-card-label">Avg Stress</div><div class="health-card-sub" id="health-stress-detail">Max: --</div></div>
                    <div class="health-card"><div class="health-card-icon steps"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 4v16M7 4v16M19 4v16"/></svg></div><div class="health-card-value" id="health-steps">--</div><div class="health-card-label">Steps (today)</div><div class="health-card-sub" id="health-steps-detail">Goal: --</div></div>
                    <div class="health-card"><div class="health-card-icon hrv"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div><div class="health-card-value" id="health-distance">--</div><div class="health-card-label">Distance (steps)</div><div class="health-card-sub" id="health-distance-detail">km walked</div></div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-card-header"><span class="chart-card-title">Sleep Trend (14 days)</span></div>
                    <div class="chart-container"><canvas id="sleep-chart"></canvas></div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-card-header"><span class="chart-card-title">Stress Trend (14 days)</span></div>
                    <div class="chart-container"><canvas id="stress-chart"></canvas></div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-card-header"><span class="chart-card-title">Steps Trend (14 days)</span></div>
                    <div class="chart-container"><canvas id="steps-chart"></canvas></div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
(function() {
    const CONFIG = {
        MAPBOX_TOKEN: 'pk.eyJ1Ijoidm9sb2NhcnUiLCJhIjoiY201OWZ0b2NjMGd3dDJscTNveGF6YWd1cCJ9.ELUlmjALZSBNFsTqLdBxqA',
        ROUTE_COLORS: ['#8b5cf6','#22c55e','#3b82f6','#f59e0b','#ef4444','#ec4899','#14b8a6','#f97316']
    };
    
    let ROUTES = [];
    let HEALTH = { sleep: [], stress: [], steps: [] };
    let map = null, mapInitialized = false;
    let sleepChart = null, stressChart = null, stepsChart = null;
    
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);
    
    // Decode polyline string to coordinates array
    function decodePolyline(encoded) {
        if (!encoded || typeof encoded !== 'string') return [];
        const coords = [];
        let index = 0, lat = 0, lng = 0;
        while (index < encoded.length) {
            let b, shift = 0, result = 0;
            do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
            lat += (result & 1) ? ~(result >> 1) : (result >> 1);
            shift = 0; result = 0;
            do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
            lng += (result & 1) ? ~(result >> 1) : (result >> 1);
            coords.push([lng / 1e5, lat / 1e5]);
        }
        return coords;
    }
    
    // Load activities from API
    async function loadActivities() {
        try {
            const res = await fetch('/api/activities');
            const data = await res.json();
            if (data.success && data.activities) {
                ROUTES = data.activities.map(a => {
                    // Parse coords - could be encoded polyline string or JSON array
                    let coords = [];
                    if (a.coords) {
                        if (typeof a.coords === 'string') {
                            // Check if it's JSON array or polyline
                            if (a.coords.startsWith('[')) {
                                try { coords = JSON.parse(a.coords); } catch(e) {}
                            } else {
                                coords = decodePolyline(a.coords);
                            }
                        } else if (Array.isArray(a.coords)) {
                            coords = a.coords;
                        }
                    }
                    
                    // Format date
                    let dateStr = a.date;
                    if (dateStr && dateStr.includes('T')) {
                        dateStr = dateStr.split('T')[0];
                    }
                    
                    return {
                        id: a.id,
                        name: a.name,
                        date: dateStr,
                        distance: parseFloat(a.distance) || 0,
                        pace: a.pace,
                        duration: parseInt(a.duration) || 0,
                        hr: a.avg_hr,
                        maxHr: a.max_hr,
                        elevation: parseInt(a.elevation) || 0,
                        calories: parseInt(a.calories) || 0,
                        coords: coords
                    };
                });
                updateDashboard();
                renderActivityList();
            }
        } catch (e) {
            console.error('Error loading activities:', e);
            $('activity-list').innerHTML = '<div class="loading">Error loading activities</div>';
        }
    }
    
    // Load health data from API
    async function loadHealthData() {
        try {
            const res = await fetch('/api/health');
            const data = await res.json();
            if (data.success) {
                HEALTH = data;
                updateHealthCards();
                renderHealthCharts();
            }
        } catch (e) {
            console.error('Error loading health data:', e);
        }
    }
    
    function updateDashboard() {
        if (!ROUTES.length) return;
        
        const totalDistance = ROUTES.reduce((a, r) => a + (r.distance || 0), 0);
        const totalElevation = ROUTES.reduce((a, r) => a + (r.elevation || 0), 0);
        const totalSeconds = ROUTES.reduce((a, r) => a + (r.duration || 0), 0);
        const hours = Math.floor(totalSeconds / 3600);
        const mins = Math.floor((totalSeconds % 3600) / 60);
        
        $('stat-runs').textContent = ROUTES.length;
        $('stat-distance').innerHTML = totalDistance.toFixed(0) + '<span>km</span>';
        $('stat-time').innerHTML = hours + ':' + mins.toString().padStart(2, '0') + '<span>hrs</span>';
        $('stat-elevation').innerHTML = totalElevation.toLocaleString() + '<span>m</span>';
    }
    
    function renderActivityList() {
        const list = $('activity-list');
        if (!list || !ROUTES.length) {
            if (list) list.innerHTML = '<div class="loading">No activities found</div>';
            return;
        }
        
        const formatTime = (secs) => {
            if (!secs) return '--';
            const h = Math.floor(secs / 3600);
            const m = Math.floor((secs % 3600) / 60);
            const s = secs % 60;
            return h > 0 ? `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}` : `${m}:${s.toString().padStart(2,'0')}`;
        };
        
        list.innerHTML = ROUTES.slice(0, 20).map(r => `
            <div class="activity-item" data-id="${r.id}">
                <div class="activity-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                <div class="activity-info">
                    <div class="activity-name">${r.name || 'Run'}</div>
                    <div class="activity-meta">${r.date}</div>
                </div>
                <div class="activity-stats">
                    <div class="activity-stat"><div class="activity-stat-value">${r.distance?.toFixed(1) || '--'}km</div><div class="activity-stat-label">Distance</div></div>
                    <div class="activity-stat"><div class="activity-stat-value">${r.pace || '--'}</div><div class="activity-stat-label">Pace</div></div>
                    <div class="activity-stat"><div class="activity-stat-value">${formatTime(r.duration)}</div><div class="activity-stat-label">Time</div></div>
                </div>
            </div>
        `).join('');
    }
    
    function updateHealthCards() {
        // Sleep - latest
        if (HEALTH.sleep && HEALTH.sleep.length > 0) {
            const latest = HEALTH.sleep[0];
            $('health-sleep').textContent = latest.totalHours + 'h';
            $('health-sleep-detail').textContent = `Deep: ${latest.deepHours}h | REM: ${latest.remHours}h`;
        }
        
        // Stress - latest
        if (HEALTH.stress && HEALTH.stress.length > 0) {
            const latest = HEALTH.stress[0];
            $('health-stress').textContent = latest.avg_stress;
            $('health-stress-detail').textContent = `Max: ${latest.max_stress}`;
        }
        
        // Steps - latest
        if (HEALTH.steps && HEALTH.steps.length > 0) {
            const latest = HEALTH.steps[0];
            $('health-steps').textContent = latest.steps?.toLocaleString() || '--';
            $('health-steps-detail').textContent = `Goal: ${latest.goal?.toLocaleString() || '--'}`;
            $('health-distance').textContent = latest.distanceKm || '--';
        }
    }
    
    function renderHealthCharts() {
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } },
                y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } }
            }
        };
        
        // Sleep chart
        if (HEALTH.sleep && HEALTH.sleep.length > 0) {
            const ctx = $('sleep-chart').getContext('2d');
            const labels = HEALTH.sleep.map(s => s.date?.split('-').slice(1).join('/')).reverse();
            const data = HEALTH.sleep.map(s => parseFloat(s.totalHours)).reverse();
            
            if (sleepChart) sleepChart.destroy();
            sleepChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: 'rgba(168, 85, 247, 0.6)',
                        borderColor: '#a855f7',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, min: 0, max: 10 } } }
            });
        }
        
        // Stress chart
        if (HEALTH.stress && HEALTH.stress.length > 0) {
            const ctx = $('stress-chart').getContext('2d');
            const labels = HEALTH.stress.map(s => s.date?.split('-').slice(1).join('/')).reverse();
            const data = HEALTH.stress.map(s => s.avg_stress).reverse();
            
            if (stressChart) stressChart.destroy();
            stressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, min: 0, max: 100 } } }
            });
        }
        
        // Steps chart
        if (HEALTH.steps && HEALTH.steps.length > 0) {
            const ctx = $('steps-chart').getContext('2d');
            const labels = HEALTH.steps.map(s => s.date?.split('-').slice(1).join('/')).reverse();
            const data = HEALTH.steps.map(s => s.steps).reverse();
            const goals = HEALTH.steps.map(s => s.goal).reverse();
            
            if (stepsChart) stepsChart.destroy();
            stepsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { data, backgroundColor: 'rgba(34, 197, 94, 0.6)', borderColor: '#22c55e', borderWidth: 1, borderRadius: 4, label: 'Steps' },
                        { data: goals, type: 'line', borderColor: '#888', borderDash: [5, 5], pointRadius: 0, label: 'Goal' }
                    ]
                },
                options: chartOptions
            });
        }
    }
    
    function initMap() {
        if (mapInitialized || !$('map')) return;
        if (typeof mapboxgl === 'undefined') { setTimeout(initMap, 500); return; }
        
        try {
            mapboxgl.accessToken = CONFIG.MAPBOX_TOKEN;
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: [26.1, 44.41],
                zoom: 12
            });
            map.on('load', () => {
                mapInitialized = true;
                addRoutesToMap();
                renderRoutesList();
            });
        } catch (e) { console.error('Map error:', e); }
    }
    
    function addRoutesToMap() {
        if (!map || !ROUTES.length) return;
        
        const routesWithCoords = ROUTES.filter(r => r.coords && r.coords.length > 2);
        $('routes-count').textContent = routesWithCoords.length;
        
        routesWithCoords.forEach((r, i) => {
            const sid = 'route-' + r.id;
            if (map.getSource(sid)) return;
            
            map.addSource(sid, {
                type: 'geojson',
                data: { type: 'Feature', geometry: { type: 'LineString', coordinates: r.coords } }
            });
            map.addLayer({
                id: 'layer-' + r.id,
                type: 'line',
                source: sid,
                paint: { 'line-color': CONFIG.ROUTE_COLORS[i % CONFIG.ROUTE_COLORS.length], 'line-width': 3, 'line-opacity': 0.8 }
            });
        });
        
        // Fit bounds
        const allCoords = routesWithCoords.flatMap(r => r.coords);
        if (allCoords.length) {
            const bounds = allCoords.reduce((b, c) => b.extend(c), new mapboxgl.LngLatBounds(allCoords[0], allCoords[0]));
            map.fitBounds(bounds, { padding: 40 });
        }
    }
    
    function renderRoutesList() {
        const list = $('routes-list');
        if (!list) return;
        
        const routesWithCoords = ROUTES.filter(r => r.coords && r.coords.length > 2);
        list.innerHTML = routesWithCoords.slice(0, 50).map(r => `
            <div class="route-item" data-id="${r.id}">
                <div class="route-item-name">${r.name || 'Run'}</div>
                <div class="route-item-meta"><span>${r.date}</span><span>${r.distance?.toFixed(1) || '--'}km</span><span>${r.pace || '--'}</span></div>
            </div>
        `).join('');
    }
    
    async function syncStrava() {
        const btn = $('sync-btn');
        if (!btn || btn.classList.contains('syncing')) return;
        
        btn.classList.add('syncing');
        btn.querySelector('span').textContent = 'Syncing...';
        
        try {
            const res = await fetch('/api/strava/sync', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                alert('✅ Synced ' + data.total + ' runs from Strava!');
                loadActivities();
            } else {
                alert('❌ Sync failed: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            alert('❌ Sync error: ' + e.message);
        } finally {
            btn.classList.remove('syncing');
            btn.querySelector('span').textContent = 'Sync Strava';
        }
    }
    
    function navigateTo(page) {
        $$('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.page === page));
        $$('.page-panel').forEach(p => p.classList.remove('active'));
        const panel = $('page-' + page);
        if (panel) panel.classList.add('active');
        
        const titles = { dashboard: 'Dashboard', maps: 'Running Maps', health: 'Health & Recovery' };
        $('page-title').textContent = titles[page] || 'Dashboard';
        
        if (page === 'maps') setTimeout(initMap, 200);
    }
    
    function toggleSidebar() { $('sidebar').classList.toggle('collapsed'); }
    function toggleTheme() {
        const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', t);
        try { localStorage.setItem('theme', t); } catch(e) {}
    }
    
    function init() {
        try { const t = localStorage.getItem('theme'); if (t) document.documentElement.setAttribute('data-theme', t); } catch(e) {}
        
        // Event listeners
        $$('.nav-item').forEach(item => item.addEventListener('click', e => { e.preventDefault(); navigateTo(item.dataset.page); }));
        if ($('sidebar-toggle')) $('sidebar-toggle').addEventListener('click', toggleSidebar);
        if ($('theme-toggle')) $('theme-toggle').addEventListener('click', toggleTheme);
        if ($('sync-btn')) $('sync-btn').addEventListener('click', syncStrava);
        
        // Load data
        loadActivities();
        loadHealthData();
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
</body>
</html>
